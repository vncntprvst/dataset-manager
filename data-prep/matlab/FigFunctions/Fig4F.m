%Fig4F.m
% Dynamic Table

function Fig4F(subj_figs,summary_data_path,nwb)
    clearvars -except subj_session_id subj_figs primary_experiments_table subj nwb output_path summary_data_path
    if contains(subj_figs,' 4f')
    
        load(strcat(summary_data_path, "\IndividualFigures\Fig4\F\kvplot.mat"));
        load(strcat(summary_data_path, "\IndividualFigures\Fig4\F\knplot.mat"));
        load(strcat(summary_data_path, "\IndividualFigures\Fig4\F\magkplot.mat"));
        corr = load(strcat(summary_data_path, "\IndividualFigures\Fig4\F\corrplot.mat"));
        load(strcat(summary_data_path, "\IndividualFigures\Fig4\F\corrSEplot.mat"));
        corrtmp = corr;
    
        %Create dynamic table
        col1 = types.hdmf_common.VectorData( ...
            'description', 'Vessel Phase Gradient (rad/mm)', ...
            'data', kvplot);
        col1_len = length(col1.data);
        col2 = types.hdmf_common.VectorData( ...
            'description', 'Neuronal Phase Gradient (rad/mm)', ...
            'data', knplot);
        table_4F_kv_vs_kn = types.hdmf_common.DynamicTable( ...
            'description', 'analysis table', ...
            'Vessel Phase Gradient', col1, ...
            'Neuronal Phase Gradient', col2, ...
            'id', types.hdmf_common.ElementIdentifiers('data', linspace(1,col1_len,col1_len)) ...
            );
        nwb.analysis.set('PiaRestKvKn4F', table_4F_kv_vs_kn);
        %Create dynamic table
        col1 = types.hdmf_common.VectorData( ...
            'description', 'Magnitude K; kv kn in quadrature (rad/mm)', ...
            'data', magktosave);
        col1_len = length(col1.data);
        col2 = types.hdmf_common.VectorData( ...
            'description', 'Connected Correlation M', ...
            'data', corrtmp);
        col3 = types.hdmf_common.VectorData( ...
            'description', 'Connected Correlation SE', ...
            'data', corrSE);
        table_4F_correlation = types.hdmf_common.DynamicTable( ...
            'description', 'analysis table', ...
            'Magnitude K', col1, ...
            'Connected Correlation', col2, ...
            'Connected Correlation SE',col3,...
            'id', types.hdmf_common.ElementIdentifiers('data', linspace(1,col1_len,col1_len)) ...
            );
        nwb.analysis.set('PiaVesselNeuralKCorrelation4F', table_4F_correlation);
    end
end