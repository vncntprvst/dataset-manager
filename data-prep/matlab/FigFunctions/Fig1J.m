%Fig1J.m
% Dynamic Table

function Fig1J(subj_figs,summary_data_path,nwb)
    clearvars -except subj_session_id summary_data_path subj_figs primary_experiments_table subj nwb output_path
    if contains(subj_figs,' 1j')
        
        %Scatter plot, invVar vs diameter modulation
        
        table = readtable(strcat(summary_data_path, '\IndividualFigures\Fig1\J\Flux_Diameter_Modulation.csv'));

        is_pia = logical(table.is_pia);
        beta = table.q2r_k;
        beta_invVAR = table.q2r_invVAR;
        avg_diam = table.avg_diameter_um;

        pia_beta = beta(is_pia);
        PA_beta = beta(~is_pia);
        pia_beta_invVAR = beta_invVAR(is_pia);
        PA_beta_invVAR = beta_invVAR(~is_pia);
        pia_Diam = avg_diam(is_pia);
        PA_Diam = avg_diam(~is_pia);

        %Assign to dynamic table: Pia
        col1 = types.hdmf_common.VectorData( ...
            'description', 'Pia Beta', ...
            'data', pia_beta);
        col1_len = length(col1.data);
        col2 = types.hdmf_common.VectorData( ...
            'description', 'Pia Beta Inverse Variance', ...
            'data', pia_beta_invVAR);
        col3 = types.hdmf_common.VectorData( ...
            'description', 'Pia Average Diameter (um)', ...
            'data', pia_Diam);
        table_1J_Pia = types.hdmf_common.DynamicTable( ...
            'description', 'analysis table', ...
            'Pia Beta', col1, ...
            'Pia Beta Inverse Variance', col2, ...
            'Pia Average Diameter',col3,...
            'id', types.hdmf_common.ElementIdentifiers('data', linspace(1,col1_len,col1_len)) ...
            );
        table_1J_Pia;
        nwb.analysis.set('PiaFluxDiameterModulation1J', table_1J_Pia);

        %Assign to dynamic table: Pia
        col1 = types.hdmf_common.VectorData( ...
            'description', 'PA Beta', ...
            'data', PA_beta);
        col1_len = length(col1.data);
        col2 = types.hdmf_common.VectorData( ...
            'description', 'PA Beta Inverse Variance', ...
            'data', PA_beta_invVAR);
        col3 = types.hdmf_common.VectorData( ...
            'description', 'PA Average Diameter (um)', ...
            'data', PA_Diam);
        table_1J_PA = types.hdmf_common.DynamicTable( ...
            'description', 'analysis table', ...
            'PA Beta', col1, ...
            'PA Beta Inverse Variance', col2, ...
            'PA Average Diameter',col3,...
            'id', types.hdmf_common.ElementIdentifiers('data', linspace(1,col1_len,col1_len)) ...
            );
        table_1J_PA;
        nwb.analysis.set('PAFluxDiameterModulation1J', table_1J_PA);
    end
end