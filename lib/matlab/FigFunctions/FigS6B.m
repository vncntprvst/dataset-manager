%FigS6B.m
% Dynamic Table

function FigS6B(subj_figs,summary_data_path,nwb)
    clearvars -except subj_session_id summary_data_path subj_figs primary_experiments_table subj nwb output_path
    if contains(subj_figs,' S6b')
    
        table = readtable(strcat(summary_data_path, '\IndividualFigures\FigS6\CaDCoherence.csv'));
    
        freq = table.f;
        CaDC = table.C;
        CaDCErrLow = table.CerrLow;
        CaDCErrHigh = table.CerrHigh;
    
        %Assign to dynamic table
        col1 = types.hdmf_common.VectorData( ...
            'description', 'Frequency (Hz)', ...
            'data', freq);
        col1_len = length(col1.data);
        col2 = types.hdmf_common.VectorData( ...
            'description', 'Average Ca-D Coherence', ...
            'data', CaDC);
        col3 = types.hdmf_common.VectorData( ...
            'description', 'Lower 95%CI Average Ca-D Coherence', ...
            'data', CaDCErrLow);
        col4 = types.hdmf_common.VectorData( ...
            'description', 'Upper 95%CI Average Ca-D Coherence', ...
            'data', CaDCErrHigh);
    
        table_S6B_Pts = types.hdmf_common.DynamicTable( ...
            'description', 'analysis table', ...
            'Frequency (Hz)', col1, ...
            'Average Ca-D Coherence', col2, ...
            'Ca-D Coherence Lower 95%CI', col3, ...
            'Ca-D Coherence Upper 95%CI', col4, ...
            'id', types.hdmf_common.ElementIdentifiers('data', linspace(1,col1_len,col1_len)) ...
            );
        nwb.analysis.set('AverageGCaMPandDiamterCoherenceFigureS6B', table_S6B_Pts);
    
        %PHASE
        table = readtable(strcat(summary_data_path, '\IndividualFigures\FigS6\CaDPhase.csv'));
    
        %table = readtable("Y:\DataAnalysis\VesCorrPhase\IndividualFigures\FigS6\CaDPhase.csv");
    
        freq = table.phi_f;
        phi = table.phi;
        phi2SD = table.phi95CI;
    
        %Assign to dynamic table
        col1 = types.hdmf_common.VectorData( ...
            'description', 'Frequency (Hz)', ...
            'data', freq);
        col1_len = length(col1.data);
        col2 = types.hdmf_common.VectorData( ...
            'description', 'Average Ca-D Phase', ...
            'data', phi);
        col3 = types.hdmf_common.VectorData( ...
            'description', 'Average Ca-D Phase 2SD', ...
            'data', phi2SD);
    
        table_S6B_Phase = types.hdmf_common.DynamicTable( ...
            'description', 'analysis table', ...
            'Frequency (Hz)', col1, ...
            'Average Ca-D Phase', col2, ...
            'Ca-D Phase 2SD', col3, ...
            'id', types.hdmf_common.ElementIdentifiers('data', linspace(1,col1_len,col1_len)) ...
            );
        nwb.analysis.set('AverageGCaMPandDiamterPhaseFigureS6B', table_S6B_Phase);
    end
end